Subject: [PATCH] feat: add Kubernetes deployment and service configurations for ride and user microservices
---
Index: ebikes-kafka/microservices/kubernetes/ebike-microservices.yml
===================================================================
diff --git a/ebikes-kafka/microservices/kubernetes/ebike-microservices.yml b/ebikes-kafka/microservices/kubernetes/ebike-microservices.yml
deleted file mode 100644
--- a/ebikes-kafka/microservices/kubernetes/ebike-microservices.yml	(revision d7db587db5180b47248e645ebefd478cc8de4c76)
+++ /dev/null	(revision d7db587db5180b47248e645ebefd478cc8de4c76)
@@ -1,54 +0,0 @@
-apiVersion: apps/v1
-kind: Deployment
-metadata:
-  name: ebike-microservice
-  namespace: ebikes
-spec:
-  replicas: 1
-  selector:
-    matchLabels:
-      app: ebike-microservice
-  template:
-    metadata:
-      labels:
-        app: ebike-microservice
-    spec:
-      initContainers:
-        - name: wait-for-eureka
-          image: busybox
-          command: ['sh', '-c', 'until nc -z eureka-server 8761; do echo waiting for eureka; sleep 2; done;']
-        - name: wait-for-mongodb
-          image: busybox
-          command: ['sh', '-c', 'until nc -z mongodb 27017; do echo waiting for mongodb; sleep 2; done;']
-        - name: wait-for-kafka
-          image: busybox
-          command: ['sh', '-c', 'until nc -z kafka 9092; do echo waiting for kafka; sleep 2; done;']
-        # - name: wait-for-map
-        #   image: busybox
-        #   command: ['sh', '-c', 'until nc -z map-microservice 8082; do echo waiting for map-microservice; sleep 2; done;']
-      containers:
-        - name: ebike-microservice
-          image: microservices-ebike-microservice:latest
-          imagePullPolicy: Never
-          ports:
-            - containerPort: 8080
-            - containerPort: 8081
-          envFrom:
-            - configMapRef:
-                name: ebikes-config
----
-apiVersion: v1
-kind: Service
-metadata:
-  name: ebike-microservice
-  namespace: ebikes
-spec:
-  selector:
-    app: ebike-microservice
-  ports:
-    - name: http
-      port: 8080
-      targetPort: 8080
-    - name: management
-      port: 8081
-      targetPort: 8081
Index: ebikes-kafka/microservices/kubernetes/kafka.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ebikes-kafka/microservices/kubernetes/kafka.yml b/ebikes-kafka/microservices/kubernetes/kafka.yml
--- a/ebikes-kafka/microservices/kubernetes/kafka.yml	(revision d7db587db5180b47248e645ebefd478cc8de4c76)
+++ b/ebikes-kafka/microservices/kubernetes/kafka.yml	(date 1745527980790)
@@ -22,7 +22,7 @@
             - |
               apk add --no-cache bind-tools netcat-openbsd
               echo "Waiting for Zookeeper DNS and port..."
-              until nslookup zookeeper && nc -z zookeeper 2181; do
+              until nslookup zookeeper.ebikes.svc.cluster.local && nc -z zookeeper.ebikes.svc.cluster.local 2181; do
                 echo "Zookeeper not ready yet..."
                 sleep 2
               done
@@ -31,6 +31,22 @@
       containers:
         - name: kafka
           image: confluentinc/cp-kafka:7.5.0
+          command:
+            - sh
+            - -c
+            - |
+              echo "=== DEBUG: getent hosts for Zookeeper ==="
+              getent hosts zookeeper.ebikes.svc.cluster.local || true
+              echo "=== DEBUG: ping Zookeeper ==="
+              ping -c 3 zookeeper.ebikes.svc.cluster.local || true
+              echo "=== DEBUG: nc connectivity to Zookeeper:2181 ==="
+              nc -zv zookeeper.ebikes.svc.cluster.local 2181 || true
+              echo "=== DEBUG: /etc/hosts ==="
+              cat /etc/hosts
+              echo "=== DEBUG: env ==="
+              env
+              echo "=== DEBUG: Starting Kafka ==="
+              /etc/confluent/docker/run
           ports:
             - containerPort: 9092
             - containerPort: 29092
@@ -38,7 +54,7 @@
             - name: KAFKA_BROKER_ID
               value: "1"
             - name: KAFKA_ZOOKEEPER_CONNECT
-              value: "zookeeper:2181"
+              value: "zookeeper.ebikes.svc.cluster.local:2181"
             - name: KAFKA_LISTENERS
               value: "PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092"
             - name: KAFKA_ADVERTISED_LISTENERS
@@ -49,12 +65,12 @@
               value: "PLAINTEXT"
             - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
               value: "1"
-#            - name: KAFKA_LOG4J_ROOT_LOGLEVEL
-#              value: "DEBUG"
-#            - name: KAFKA_TOOLS_LOG4J_LOGLEVEL
-#              value: "DEBUG"
-#            - name: KAFKA_OPTS
-#              value: "-Djava.net.preferIPv4Stack=true -Dlog4j.debug=true"
+            - name: KAFKA_LOG4J_ROOT_LOGLEVEL
+              value: "DEBUG"
+            - name: KAFKA_TOOLS_LOG4J_LOGLEVEL
+              value: "DEBUG"
+            - name: KAFKA_OPTS
+              value: "-Djava.net.preferIPv4Stack=true -Dlog4j.debug=true"
           volumeMounts:
             - name: kafka-data
               mountPath: /var/lib/kafka/data
Index: ebikes-kafka/microservices/kubernetes/ride-microservice.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ebikes-kafka/microservices/kubernetes/ride-microservice.yml b/ebikes-kafka/microservices/kubernetes/ride-microservice.yml
new file mode 100644
--- /dev/null	(date 1745526435489)
+++ b/ebikes-kafka/microservices/kubernetes/ride-microservice.yml	(date 1745526435489)
@@ -0,0 +1,50 @@
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: ride-microservice
+  namespace: ebikes
+spec:
+  replicas: 1
+  selector:
+    matchLabels:
+      app: ride-microservice
+  template:
+    metadata:
+      labels:
+        app: ride-microservice
+    spec:
+      initContainers:
+        - name: wait-for-eureka
+          image: busybox
+          command: ['sh', '-c', 'until nc -z eureka-server 8761; do echo waiting for eureka; sleep 2; done;']
+        - name: wait-for-ebike
+          image: busybox
+          command: ['sh', '-c', 'until nc -z ebike-microservice 8080; do echo waiting for ebike-microservice; sleep 2; done;']
+        - name: wait-for-user
+          image: busybox
+          command: ['sh', '-c', 'until nc -z user-microservice 8080; do echo waiting for user-microservice; sleep 2; done;']
+        - name: wait-for-map
+          image: busybox
+          command: ['sh', '-c', 'until nc -z map-microservice 8080; do echo waiting for map-microservice; sleep 2; done;']
+      containers:
+        - name: ride-microservice
+          image: microservices-ride-microservice:latest
+          imagePullPolicy: Never
+          ports:
+            - containerPort: 8080
+          envFrom:
+            - configMapRef:
+                name: ebikes-config
+---
+apiVersion: v1
+kind: Service
+metadata:
+  name: ride-microservice
+  namespace: ebikes
+spec:
+  selector:
+    app: ride-microservice
+  ports:
+    - name: http
+      port: 8080
+      targetPort: 8080
\ No newline at end of file
Index: ebikes-kafka/microservices/kubernetes/user-microservice.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ebikes-kafka/microservices/kubernetes/user-microservice.yml b/ebikes-kafka/microservices/kubernetes/user-microservice.yml
new file mode 100644
--- /dev/null	(date 1745526235443)
+++ b/ebikes-kafka/microservices/kubernetes/user-microservice.yml	(date 1745526235443)
@@ -0,0 +1,48 @@
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: user-microservice
+  namespace: ebikes
+spec:
+  replicas: 1
+  selector:
+    matchLabels:
+      app: user-microservice
+  template:
+    metadata:
+      labels:
+        app: user-microservice
+    spec:
+      initContainers:
+        - name: wait-for-eureka
+          image: busybox
+          command: ['sh', '-c', 'until nc -z eureka-server 8761; do echo waiting for eureka; sleep 2; done;']
+        - name: wait-for-mongodb
+          image: busybox
+          command: ['sh', '-c', 'until nc -z mongodb 27017; do echo waiting for mongodb; sleep 2; done;']
+      containers:
+        - name: user-microservice
+          image: microservices-user-microservice:latest
+          imagePullPolicy: Never
+          ports:
+            - containerPort: 8080
+            - containerPort: 8081
+          envFrom:
+            - configMapRef:
+                name: ebikes-config
+---
+apiVersion: v1
+kind: Service
+metadata:
+  name: user-microservice
+  namespace: ebikes
+spec:
+  selector:
+    app: user-microservice
+  ports:
+    - name: http
+      port: 8080
+      targetPort: 8080
+    - name: adapter-ride
+      port: 8081
+      targetPort: 8081
\ No newline at end of file
Index: ebikes-kafka/microservices/kubernetes/ebike-microservice.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ebikes-kafka/microservices/kubernetes/ebike-microservice.yml b/ebikes-kafka/microservices/kubernetes/ebike-microservice.yml
new file mode 100644
--- /dev/null	(date 1745526492675)
+++ b/ebikes-kafka/microservices/kubernetes/ebike-microservice.yml	(date 1745526492675)
@@ -0,0 +1,54 @@
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: ebike-microservice
+  namespace: ebikes
+spec:
+  replicas: 1
+  selector:
+    matchLabels:
+      app: ebike-microservice
+  template:
+    metadata:
+      labels:
+        app: ebike-microservice
+    spec:
+      initContainers:
+        - name: wait-for-eureka
+          image: busybox
+          command: ['sh', '-c', 'until nc -z eureka-server 8761; do echo waiting for eureka; sleep 2; done;']
+        - name: wait-for-mongodb
+          image: busybox
+          command: ['sh', '-c', 'until nc -z mongodb 27017; do echo waiting for mongodb; sleep 2; done;']
+        - name: wait-for-kafka
+          image: busybox
+          command: ['sh', '-c', 'until nc -z kafka 9092; do echo waiting for kafka; sleep 2; done;']
+        - name: wait-for-map
+          image: busybox
+          command: ['sh', '-c', 'until nc -z map-microservice 8082; do echo waiting for map-microservice; sleep 2; done;']
+      containers:
+        - name: ebike-microservice
+          image: microservices-ebike-microservice:latest
+          imagePullPolicy: Never
+          ports:
+            - containerPort: 8080
+            - containerPort: 8081
+          envFrom:
+            - configMapRef:
+                name: ebikes-config
+---
+apiVersion: v1
+kind: Service
+metadata:
+  name: ebike-microservice
+  namespace: ebikes
+spec:
+  selector:
+    app: ebike-microservice
+  ports:
+    - name: http
+      port: 8080
+      targetPort: 8080
+    - name: management
+      port: 8081
+      targetPort: 8081
